# Implement DALL-E 
âš ï¸This is an advanced part of the workshop and will provide less guidance than the other sections.âš ï¸

In this section, we will add support for generating an image based on the recipe generated by the first section. This involves creating a new endpoint in the backend to generate the image, and some logic in the frontend to fetch the image based on the dish and rendering it to the user.

## Checking out the existing recipe endpoint
The backend resides in the `api`-folder. The backend is written with [ExpressJS](https://expressjs.com/) middleware, which allows us to easily create HTTP endpoints. Open the `index.ts`-file and check out how the `/recipes`-endpoint is created:

```ts
app.post("/recipes", async (req: Request, res: Response) => {
...
});
```

The `app` object is the ExpressJS instantiation, which allows us to create a HTTP `POST` endpoint at the path `/recipes`. The `async` keyword is added because we need to perform asynchronous requests to the OpenAI server. Lastly, we have the `req` and `res` parameters. `req` contains the incoming request with all the necessary data, like the request body. `res` allows us to build the response with the required data, set response header, statuses and such. 

## Using the OpenAI API
ðŸ’¡It could be a good idea to familiarize yourself with DALL-E if you're not familiar with how it works by trying out a few prompt here: https://labs.openai.com/ ðŸ’¡

As seen in the `openAIRequest` in the `index.ts`-file, we are using the OpenAI API to build our OpenAI requests. For the language models used in the `/recipes`-endpoint, we are using the `createCompletion` function, however when using DALL-E, we need a different function. As shown in the [DALL-E documentation](https://platform.openai.com/docs/guides/images/usage?lang=node.js), this function is used as following: 

```ts
const response = await openai.createImage({
  prompt: "a white siamese cat",
  n: 1,
  size: "1024x1024",
});
image_url = response.data.data[0].url;
```

Try and create a separate `dalleRequest` function in the same way as the `openAIRequest` function. 

_Tip: The `format` constant is not applicable in this function. Also, maybe change the function parameters to something other than the ingredients. For example `title` and/or `description`?_

<details>
<summary>âœ¨Show solutionâœ¨</summary>

```ts
const dalleRequest = (dish: string) => {
  return openai.createImage({
    prompt: `Create a hyperrealistic image in the style of a menu image at a fancy restaurant of the following dish: ${dish}"`,
    n: 1,
    size: "512x512",
  });
};
```
</details>

## Adding a new endpoint
By taking inspiration from the existing `recipes`-endpoint, try creating another new endpoint at `/image` that uses the `dalleRequest` and returns the image URL.

<details>
<summary>âœ¨Show solutionâœ¨</summary>
The solution contains a little bit of error handling, but this is not required.

```ts
app.post("/image", async (req: Request, res: Response) => {
  console.info("Received image request with request body: ", req.body);
  const dish: string = req.body.title;

  if (!dish) {
    const error = {
      message: "No ingredients provided, aborting Dall-E request",
    };
    console.error(error.message);
    res.status(400).send(error);
    return;
  }

  try {
    const response = await dalleRequest(dish);

    if (!response) return res.send("No response from OpenAI");
    if (!response.data) return res.send("No data from OpenAI");

    const image = response.data.data[0];

    res.send(image);
  } catch (error) {
    res.send("OpenAI servers are busy, please try again");
  }
});
```
</details>

## Displaying the image in frontend
We're now going back to the root folder and into the `App.tsx`-file. Let's generate an image only if the user wants it. A `Generate image`-button should work fine. This button should work a lot like the `Get recipe`-button, but perform a request to our new `/image` endpoint instead. The response should also be added to a new state object, so that an image may be shown.

<details>
<summary>âœ¨Show solutionâœ¨</summary>

Fetching logic:
```ts
    const [imageUrl, setImageUrl] = useState<string>("");
    const generateImage = async () => {
        const requestBody = JSON.stringify({dish: recipe.title});
        await fetch("http://localhost:8000/image", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: requestBody,
        })
          .then((response) => response.json())
          .then((data) => setImageUrl(data.url));
      }
```

Button and image:
```jsx
<Button onClick={() => generateImage()}>Generate image</Button>
{imageUrl && <img src={imageUrl}/>}
```
</details>
